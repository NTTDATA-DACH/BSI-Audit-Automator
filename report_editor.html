<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSI Audit Report Editor</title>
    <style>
        :root {
            --primary-color: #003359;
            --secondary-color: #0073e6;
            --background-color: #f4f7fa;
            --text-color: #333;
            --border-color: #d1d9e6;
            --header-bg: #fff;
            --card-bg: #fff;
            --button-bg: #005cbf;
            --button-hover-bg: #004a99;
            --danger-color: #d93025;
            --danger-hover-color: #a52714;
            --sidebar-width: 320px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            display: flex;
        }
        body.print-mode {
            display: block;
            background-color: white;
        }
        .sidebar-nav {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        body.print-mode .sidebar-nav {
            display: none;
        }
        .sidebar-nav h2 {
            font-size: 1.4em;
            color: var(--primary-color);
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        #nav-search {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .sidebar-nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav li a {
            display: block;
            text-decoration: none;
            color: var(--secondary-color);
            padding: 8px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .sidebar-nav li a:hover {
            background-color: #eef;
        }
        .sidebar-nav ul ul {
            padding-left: 15px;
        }
        .sidebar-nav details {
            margin-left: 5px;
        }
        .sidebar-nav summary {
            cursor: pointer;
            padding: 8px 0;
            display: flex;
            align-items: center;
        }
        .sidebar-nav summary:hover {
            background-color: #f8f8f8;
        }
        .sidebar-nav summary a {
            padding: 0;
            display: inline;
        }
        .sidebar-nav li a.chapter-title {
            font-weight: bold;
            color: var(--primary-color);
        }

        #main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
        }
        body.print-mode #main-content {
            margin-left: 0;
            width: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        body.print-mode .container {
            max-width: 210mm;
            padding: 0;
        }
        header {
            background-color: var(--header-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        body.print-mode header {
            display: none;
        }
        header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8em;
        }
        #controls { display: flex; align-items: center; gap: 15px; }
        #controls button, #controls input[type="file"]::file-selector-button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #controls button:hover, #controls input[type="file"]::file-selector-button:hover { background-color: var(--button-hover-bg); }
        #controls button:disabled { background-color: #999; cursor: not-allowed; }
        
        .chapter {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 25px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        body.print-mode .chapter {
            border: none;
            box-shadow: none;
            page-break-inside: avoid;
            margin-top: 0;
            padding-top: 20px;
        }
        .chapter h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .subchapter {
            margin-top: 20px;
            padding-left: 20px;
            border-left: 3px solid #eef;
        }
        body.print-mode .subchapter {
            border-left: none;
            padding-left: 0;
        }
        h3 { color: var(--primary-color); font-weight: 600; }
        h4 { color: #555; }
        p.description { color: #555; font-style: italic; }
        
        .content-item, .prose-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
        }
        body.print-mode .content-item {
            border: none;
            padding: 5px 0;
        }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1em;
        }
        textarea { min-height: 80px; resize: vertical; }
        body.print-mode textarea {
            border: none;
            background: none;
            resize: none;
            padding: 0;
            min-height: auto;
            height: auto;
            overflow: visible;
        }
        body.print-mode input, body.print-mode select {
            border: none;
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        th { background-color: #f2f2f2; font-weight: bold; }
        td input, td textarea, td select { padding: 4px; width: 100%; box-sizing: border-box;}
        body.print-mode td textarea {
            padding: 0;
        }
        .action-cell { width: 80px; text-align: center; }
        body.print-mode .action-cell { display: none; }
        .delete-row-btn, .add-row-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .delete-row-btn:hover { background-color: var(--danger-hover-color); }
        .add-row-btn {
            background-color: var(--button-bg);
            margin-top: 10px;
        }
        .add-row-btn:hover { background-color: var(--button-hover-bg); }
        body.print-mode .add-row-btn,
        body.print-mode .delete-row-btn { display: none; }

        fieldset.baustein-pruefung {
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        fieldset.baustein-pruefung legend {
            font-weight: bold;
            color: var(--primary-color);
            padding: 0 10px;
        }

        /* STYLES FOR CHAPTER 5.5.2 and read-only fields */
        .anforderung-block {
            border: 1px solid #e0e0e0;
            background-color: #fdfdfd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
        }
        body.print-mode .anforderung-block {
            page-break-inside: avoid;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        .read-only-field {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            min-height: 1.5em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        body.print-mode .read-only-field {
            background: none;
            border: none;
            padding: 0;
        }
        .pruefmethode-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        body.print-mode .pruefmethode-group {
            background: none;
            border: none;
            padding: 5px 0;
        }
        .pruefmethode-group label:first-child {
            font-weight: bold;
            margin-bottom: 0;
        }
        .form-check-inline {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .form-check-inline label {
            font-weight: normal; 
            margin-bottom: 0;
        }
        .form-check-inline input[type="checkbox"] {
            width: auto;
            height: 1em;
            width: 1em;
        }

        #report-container { padding-top: 20px; }
        #initial-message { text-align: center; font-size: 1.2em; color: #888; margin-top: 50px; }

        /* Print-specific styles */
        .cover-page {
            display: none;
        }
        body.print-mode .cover-page {
            display: block;
            page-break-after: always;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
        }
        .cover-page h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 30px;
        }
        .cover-page .metadata {
            font-size: 1.2em;
            line-height: 2;
            margin-top: 50px;
        }
        .cover-page .metadata div {
            margin: 10px 0;
        }

        .table-of-contents {
            display: none;
        }
        body.print-mode .table-of-contents {
            display: block;
            page-break-after: always;
            padding: 40px;
        }
        .table-of-contents h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .toc-entry {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        .toc-entry.level-1 {
            font-weight: bold;
            margin-top: 15px;
        }
        .toc-entry.level-2 {
            padding-left: 20px;
        }
        .toc-entry.level-3 {
            padding-left: 40px;
            font-size: 0.95em;
        }
        .toc-entry .toc-title {
            flex: 1;
        }
        .toc-entry .toc-dots {
            flex: 0 0 auto;
            margin: 0 10px;
            border-bottom: 1px dotted #999;
            height: 1em;
            min-width: 20px;
            flex-grow: 1;
        }
        .toc-entry .toc-page {
            flex: 0 0 auto;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            .chapter {
                page-break-inside: avoid;
            }
            h2, h3 {
                page-break-after: avoid;
            }
            table {
                page-break-inside: avoid;
            }
            .anforderung-block {
                page-break-inside: avoid;
            }
        }

        .print-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            z-index: 1001;
        }
        body.print-mode .print-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .print-header button {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        body.print-mode #report-container {
            margin-top: 60px;
        }
        @media print {
            .print-header {
                display: none !important;
            }
            body.print-mode #report-container {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <nav id="sidebar-nav" class="sidebar-nav">
        <h2>Navigation</h2>
        <input type="text" id="nav-search" placeholder="Search sections...">
        <ul id="nav-list"></ul>
    </nav>
    <main id="main-content">
        <header>
            <h1>BSI Audit Report Editor</h1>
            <div id="controls">
                <input type="file" id="json-file-input" accept=".json">
                <button id="print-view-button" disabled>Print View</button>
                <button id="export-json-button" disabled>Export to JSON</button>
            </div>
        </header>

        <div class="print-header">
            <span>BSI Audit Report - Print View</span>
            <button id="exit-print-button">Exit Print View</button>
        </div>

        <div class="container">
            <div id="report-container">
                <p id="initial-message">Load your <code>final_audit_report.json</code> or <code>master_report_template.json</code> to begin.</p>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('json-file-input');
            const exportButton = document.getElementById('export-json-button');
            const printViewButton = document.getElementById('print-view-button');
            const exitPrintButton = document.getElementById('exit-print-button');
            const reportContainer = document.getElementById('report-container');
            const navList = document.getElementById('nav-list');
            const navSearch = document.getElementById('nav-search');
            const initialMessage = document.getElementById('initial-message');

            let reportData = null;
            let findingInputTimeout = null;

            fileInput.addEventListener('change', handleFileSelect);
            exportButton.addEventListener('click', handleExport);
            printViewButton.addEventListener('click', enterPrintView);
            exitPrintButton.addEventListener('click', exitPrintView);
            navSearch.addEventListener('keyup', filterNav);
            
            reportContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('add-row-btn')) {
                    handleAddRow(event.target);
                }
                if (event.target.classList.contains('delete-row-btn')) {
                    handleDeleteRow(event.target);
                }
            });

            reportContainer.addEventListener('input', (event) => {
                if (event.target.matches('[data-finding-source="true"]')) {
                    clearTimeout(findingInputTimeout);
                    findingInputTimeout = setTimeout(() => {
                        handleFindingInput(event.target);
                    }, 2000); 
                }
            });

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        reportData = JSON.parse(e.target.result);
                        initialMessage.style.display = 'none';
                        renderReport(reportData);
                        createSidebarNav(reportData);
                        exportButton.disabled = false;
                        printViewButton.disabled = false;
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function enterPrintView() {
                syncUiToData();
                document.body.classList.add('print-mode');
                
                // Create cover page and TOC
                const coverPage = createCoverPage();
                const toc = createTableOfContents();
                
                // Re-render report for print
                renderReport(reportData, true);
                
                // Insert cover and TOC at beginning
                reportContainer.insertBefore(toc, reportContainer.firstChild);
                reportContainer.insertBefore(coverPage, reportContainer.firstChild);
                
                // Expand all textareas
                setTimeout(() => {
                    const textareas = reportContainer.querySelectorAll('textarea');
                    textareas.forEach(textarea => {
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    });
                }, 100);
            }

            function exitPrintView() {
                document.body.classList.remove('print-mode');
                
                // Remove cover and TOC
                const coverPage = reportContainer.querySelector('.cover-page');
                const toc = reportContainer.querySelector('.table-of-contents');
                if (coverPage) coverPage.remove();
                if (toc) toc.remove();
                
                // Re-render normal view
                renderReport(reportData, false);
            }

            function createCoverPage() {
                const cover = document.createElement('div');
                cover.className = 'cover-page';
                
                const report = reportData?.bsiAuditReport || {};
                const auditType = report.allgemeines?.audittyp?.content || 'Audit';
                const institution = report.allgemeines?.auditierteInstitution?.kontaktinformationenAntragsteller?.table?.rows?.[0]?.Institution || 'N/A';
                const kurzbezeichnung = report.allgemeines?.informationsverbund?.content?.[0]?.text || 'N/A';
                const today = new Date().toLocaleDateString('de-DE');
                
                cover.innerHTML = `
                    <h1>Auditbericht im Rahmen der Zertifizierung nach ISO 27001 auf der Basis von IT-Grundschutz</h1>
                    <div class="metadata">
                        <div><strong>Audittyp:</strong> ${auditType}</div>
                        <div><strong>Institution:</strong> ${institution}</div>
                        <div><strong>Informationsverbund:</strong> ${kurzbezeichnung}</div>
                        <div><strong>Datum:</strong> ${today}</div>
                    </div>
                `;
                
                return cover;
            }

            function createTableOfContents() {
                const toc = document.createElement('div');
                toc.className = 'table-of-contents';
                toc.innerHTML = '<h2>Inhaltsverzeichnis</h2>';
                
                const tocList = document.createElement('div');
                tocList.className = 'toc-list';
                
                const report = reportData?.bsiAuditReport || {};
                let pageNum = 3; // Start after cover and TOC
                
                function addTocEntry(title, level) {
                    const entry = document.createElement('div');
                    entry.className = `toc-entry level-${level}`;
                    entry.innerHTML = `
                        <span class="toc-title">${title}</span>
                        <span class="toc-dots"></span>
                        <span class="toc-page">${pageNum++}</span>
                    `;
                    tocList.appendChild(entry);
                }
                
                function processTocLevel(obj, level = 1) {
                    Object.keys(obj).forEach(key => {
                        const item = obj[key];
                        if (typeof item === 'object' && item !== null && item.title) {
                            const number = item.chapterNumber || item.subchapterNumber || '';
                            addTocEntry(`${number} ${item.title}`, level);
                            
                            // Process sub-items
                            Object.keys(item).forEach(subKey => {
                                const subItem = item[subKey];
                                if (typeof subItem === 'object' && subItem !== null && subItem.title && 
                                    !['title', 'chapterNumber', 'subchapterNumber', 'description'].includes(subKey)) {
                                    processTocLevel({ [subKey]: subItem }, level + 1);
                                }
                            });
                        }
                    });
                }
                
                processTocLevel(report);
                toc.appendChild(tocList);
                return toc;
            }
            
            function syncUiToData() {
                if (!reportData) return;
                const inputs = reportContainer.querySelectorAll('[data-path]');
                inputs.forEach(input => {
                    if (input.tagName === 'BUTTON') return;
                    const path = input.dataset.path;
                    let value;
                    if (input.type === 'checkbox') {
                        value = input.checked;
                    } else if (input.tagName === 'SELECT') {
                        const strVal = input.value;
                        value = strVal === 'true' ? true : (strVal === 'false' ? false : null);
                    } else {
                        value = input.value;
                    }
                    setValueByPath(reportData, path, value);
                });
            }

            function createSidebarNav(data) {
                navList.innerHTML = '';
                const report = data.bsiAuditReport || {};
                
                function buildNavRecursive(currentObject, parentUl) {
                    Object.keys(currentObject).forEach(key => {
                        const child = currentObject[key];
                        if (typeof child === 'object' && child !== null && child.title) {
                            const newPath = `${parentUl.dataset.path || 'bsiAuditReport'}.${key}`;
                            const navId = `nav-${newPath.replace(/[.\[\]]/g, '-')}`;

                            const li = document.createElement('li');
                            
                            const childKeys = Object.keys(child).filter(k => typeof child[k] === 'object' && child[k] !== null && child[k].title);
                            
                            if (childKeys.length > 0) {
                                const details = document.createElement('details');
                                const summary = document.createElement('summary');
                                const a = document.createElement('a');
                                a.href = `#${navId}`;
                                a.textContent = `${child.subchapterNumber || child.chapterNumber || ''} ${child.title}`;
                                if (!child.subchapterNumber) a.className = 'chapter-title';
                                summary.appendChild(a);
                                details.appendChild(summary);
                                
                                const nestedUl = document.createElement('ul');
                                nestedUl.dataset.path = newPath;
                                buildNavRecursive(child, nestedUl);
                                details.appendChild(nestedUl);
                                li.appendChild(details);
                            } else {
                                const a = document.createElement('a');
                                a.href = `#${navId}`;
                                a.textContent = `${child.subchapterNumber || child.chapterNumber || ''} ${child.title}`;
                                if (!child.subchapterNumber) a.className = 'chapter-title';
                                li.appendChild(a);
                            }
                            parentUl.appendChild(li);
                        }
                    });
                }
                
                navList.dataset.path = 'bsiAuditReport';
                buildNavRecursive(report, navList);
            }

            function filterNav() {
                const searchTerm = navSearch.value.toLowerCase();
                const allLi = navList.querySelectorAll('li');
                
                allLi.forEach(li => {
                    const text = li.textContent.toLowerCase();
                    const matches = text.includes(searchTerm);
                    li.style.display = matches ? '' : 'none';
                    if (matches && searchTerm) {
                        // Ensure parents are visible and open
                        let current = li;
                        while(current && current.tagName === 'LI') {
                            const parentDetails = current.closest('details');
                            if(parentDetails) {
                                parentDetails.open = true;
                                current = parentDetails.parentElement;
                            } else {
                                current = null; // stop traversing
                            }
                        }
                    }
                });
            }


            function renderReport(data, isPrintMode = false) {
                const currentScroll = window.scrollY;
                
                // Skip cover and TOC if they exist (in print mode)
                let existingCover = reportContainer.querySelector('.cover-page');
                let existingToc = reportContainer.querySelector('.table-of-contents');
                
                reportContainer.innerHTML = ''; 
                
                // Re-add cover and TOC if in print mode
                if (isPrintMode && existingCover) reportContainer.appendChild(existingCover);
                if (isPrintMode && existingToc) reportContainer.appendChild(existingToc);
                
                const report = data.bsiAuditReport;
                if (!report) return;

                for (const key in report) {
                    const chapterData = report[key];
                    if (typeof chapterData === 'object' && chapterData !== null) {
                         reportContainer.appendChild(renderChapter(key, chapterData, `bsiAuditReport.${key}`));
                    }
                }
                window.scrollTo(0, currentScroll);
            }
            
            function renderChapter(key, chapterData, path) {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter';
                chapterDiv.dataset.chapterKey = key;
                
                const navId = `nav-${path.replace(/[.\[\]]/g, '-')}`;
                if(chapterData.title) chapterDiv.innerHTML += `<h2 id="${navId}">${chapterData.chapterNumber || ''} ${chapterData.title}</h2>`;
                if(chapterData.description) chapterDiv.innerHTML += `<p class="description">${chapterData.description}</p>`;

                 // --- Custom Rendering for specific Chapters ---
                if (key === 'voraudit') {
                    chapterDiv.appendChild(renderSection('content', chapterData, path));
                    return chapterDiv;
                } else if (key === 'gesamtvotum') {
                    chapterDiv.appendChild(renderGesamtvotum(chapterData, path));
                    return chapterDiv;
                }
                // --- End Custom Rendering ---

                for (const subKey in chapterData) {
                    if (typeof chapterData[subKey] === 'object' && chapterData[subKey] !== null) {
                         chapterDiv.appendChild(renderSection(subKey, chapterData[subKey], `${path}.${subKey}`));
                    }
                }
                return chapterDiv;
            }

            function renderSection(key, sectionData, path) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'subchapter';
                
                const navId = `nav-${path.replace(/[.\[\]]/g, '-')}
