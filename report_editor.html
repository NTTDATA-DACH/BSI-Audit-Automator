<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSI Audit Report Editor</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; }
        h1, h2, h3, h4, h5 { color: #003366; }
        h1 { text-align: center; margin-bottom: 2rem; }
        h2 { border-bottom: 2px solid #003366; padding-bottom: 10px; margin-top: 2rem; }
        h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 1.5rem; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1rem; }
        label { display: block; font-weight: bold; margin-bottom: .5rem; color: #555; }
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { min-height: 100px; resize: vertical; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e9ecef; }
        .button-group { text-align: center; margin: 2rem 0; }
        button { background-color: #003366; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; margin: 0 10px; }
        button:hover { background-color: #0055a4; }
        #file-input { display: none; }
        .file-label { display: inline-block; background-color: #6c757d; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .file-label:hover { background-color: #5a6268; }
        .chapter-nav { text-align: center; margin-bottom: 2rem; padding: 1rem; background-color: #e9ecef; border-radius: 4px; }
        .chapter-nav a { margin: 0 15px; text-decoration: none; color: #003366; font-weight: bold; }
        .chapter-nav a:hover { text-decoration: underline; }
        .question-block { border-left: 4px solid #0055a4; padding-left: 15px; margin-top: 1rem; background-color: #f4f8ff; padding: 1rem; border-radius: 4px;}
        .finding-block { border-left: 4px solid #ffc107; padding-left: 15px; margin-top: 1rem; background-color: #fffaf0; padding: 1rem; border-radius: 4px;}
        .baustein-block { border: 2px solid #003366; border-radius: 8px; padding: 1.5rem; margin-top: 2rem; background-color: #fff; }
        .anforderung-block { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-top: 1.5rem; background-color: #f8f9fa; }
        .pruefmethode-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .pruefmethode-group .form-check-inline { display: flex; align-items: center; gap: 5px; }
        .form-check-input { width: auto; }
    </style>
</head>
<body>

    <div class="container">
        <h1>BSI Grundschutz Auditbericht Editor</h1>

        <div class="button-group">
            <label for="file-input" class="file-label">Laden Sie die JSON-Datei</label>
            <input type="file" id="file-input" accept=".json">
            <button id="save-button">Speichern Sie die JSON-Datei</button>
        </div>
        <p id="file-name" style="text-align:center;"></p>

        <nav id="chapter-nav" class="chapter-nav" style="display:none;"></nav>

        <form id="report-form">
            <!-- Content will be injected here -->
        </form>
    </div>

    <script>
        let jsonData = {};
        const form = document.getElementById('report-form');
        const fileInput = document.getElementById('file-input');
        const saveButton = document.getElementById('save-button');
        const fileNameDisplay = document.getElementById('file-name');
        const chapterNav = document.getElementById('chapter-nav');

        // Helper function to get nested properties
        function get(obj, path, defaultValue = undefined) {
            const keys = Array.isArray(path) ? path : path.split('.');
            let result = obj;
            for (const key of keys) {
                if (result === null || result === undefined) return defaultValue;
                result = result[key];
            }
            return result === undefined ? defaultValue : result;
        }

        // Helper function to set nested properties
        function set(obj, path, value) {
            const keys = Array.isArray(path) ? path : path.split('.');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                const key = keys[i];
                if (current[key] === undefined || typeof current[key] !== 'object' || current[key] === null) {
                    current[key] = {};
                }
                current = current[key];
            }
            current[keys[keys.length - 1]] = value;
        }

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        jsonData = JSON.parse(e.target.result);
                        fileNameDisplay.textContent = `Geladen: ${file.name}`;
                        renderForm();
                    } catch (error) {
                        alert('Fehler beim Parsen der JSON-Datei: ' + error);
                    }
                };
                reader.readAsText(file);
            }
        });

        saveButton.addEventListener('click', () => {
            updateJson();
            const dataStr = JSON.stringify(jsonData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'final_audit_report_edited.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function updateJson() {
            const elements = form.querySelectorAll('[data-path]');
            elements.forEach(element => {
                let value;
                if (element.type === 'checkbox') {
                    value = element.checked;
                } else if (element.tagName === 'SELECT') {
                    value = element.value === "true" ? true : (element.value === "false" ? false : element.value);
                } else {
                    value = element.value;
                }
                set(jsonData, element.dataset.path, value);
            });
        }
        
        form.addEventListener('change', updateJson);

        function renderForm() {
            if (!jsonData.bsiAuditReport) {
                form.innerHTML = '<p>Ungültige JSON-Struktur. "bsiAuditReport"-Schlüssel nicht gefunden.</p>';
                return;
            }
            const chapters = {
                '1': 'Allgemeines',
                '2': 'Voraudit',
                '3': 'Dokumentenprüfung',
                '4': 'Erstellung eines Prüfplans',
                '5': 'Vor-Ort-Audit',
                '6': 'Gesamtvotum',
                '7': 'Anhang'
            };
            chapterNav.innerHTML = '';
            Object.entries(chapters).forEach(([num, title]) => {
                chapterNav.innerHTML += `<a href="#chapter-${num}">${num}. ${title}</a>`;
            });
            chapterNav.style.display = 'block';

            let html = '';
            html += renderChapter1(get(jsonData, 'bsiAuditReport.allgemeines', {}));
            html += renderChapter3(get(jsonData, 'bsiAuditReport.dokumentenpruefung', {}));
            html += renderChapter4(get(jsonData, 'bsiAuditReport.erstellungEinesPruefplans', {}));
            html += renderChapter5(get(jsonData, 'bsiAuditReport.vorOrtAudit', {}));
            html += renderChapter7(get(jsonData, 'bsiAuditReport.anhang', {}));
            form.innerHTML = html;
        }
        
        function createTextInput(label, path, value) {
            return `
                <div class="form-group">
                    <label for="${path}">${label}</label>
                    <input type="text" id="${path}" data-path="${path}" value="${value || ''}">
                </div>`;
        }
        
        function createTextArea(label, path, value) {
            return `
                <div class="form-group">
                    <label for="${path}">${label}</label>
                    <textarea id="${path}" data-path="${path}">${value || ''}</textarea>
                </div>`;
        }

        function createTable(tableData, basePath) {
            if (!tableData || !tableData.headers || !tableData.rows) return '<p>Keine Tabellendaten verfügbar.</p>';
            let tableHtml = '<table><thead><tr>';
            tableData.headers.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            tableData.rows.forEach((row, rowIndex) => {
                tableHtml += '<tr>';
                tableData.headers.forEach(header => {
                    const cellPath = `${basePath}.rows[${rowIndex}].${header.replace(/\s+/g, '')}`;
                    // Special handling for checkboxes or specific inputs can be added here
                    tableHtml += `<td><textarea data-path="${cellPath}">${row[header] || ''}</textarea></td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function createQuestionBlock(questions, basePath) {
             let html = '';
             questions.forEach((q, index) => {
                if (q.type === 'question') {
                    html += `<div class="question-block">
                        <p><strong>Frage:</strong> ${q.questionText}</p>`;
                    
                    const answerPath = `${basePath}.content[${index}].answer`;
                    const answerValue = get(jsonData, answerPath);

                    if (typeof answerValue === 'boolean' || answerValue === null) {
                         html += `<div class="form-group">
                                    <label>Antwort:</label>
                                    <select data-path="${answerPath}">
                                        <option value="" ${answerValue === null ? 'selected' : ''}>Bitte wählen</option>
                                        <option value="true" ${answerValue === true ? 'selected' : ''}>Ja</option>
                                        <option value="false" ${answerValue === false ? 'selected' : ''}>Nein</option>
                                    </select>
                                  </div>`;
                    } else {
                        html += createTextArea('Antwort:', answerPath, answerValue);
                    }
                    html += '</div>';
                } else if (q.type === 'finding') {
                    const findingPath = `${basePath}.content[${index}].findingText`;
                    const findingValue = get(jsonData, findingPath, '');
                     html += `<div class="finding-block">
                                ${createTextArea('Feststellung:', findingPath, findingValue)}
                              </div>`;
                }
             });
             return html;
        }

        function renderChapter1(data) {
            let html = `<h2 id="chapter-1">1. Allgemeines</h2>`;
            const infoVerbund = get(data, 'informationsverbund.content', []);
            html += `<h3>1.4 Informationsverbund</h3>`;
            html += createTextArea('Kurzbezeichnung:', `bsiAuditReport.allgemeines.informationsverbund.content[0].text`, get(infoVerbund, '[0].text', ''));
            html += createTextArea('Kurzbeschreibung (Geltungsbereich):', `bsiAuditReport.allgemeines.informationsverbund.content[1].text`, get(infoVerbund, '[1].text', ''));
            return html;
        }

        function renderChapter3(data) {
            let html = `<h2 id="chapter-3">3. Dokumentenprüfung</h2>`;
            for (const subChapterKey in data) {
                const subChapterData = data[subChapterKey];
                if (typeof subChapterData === 'object' && subChapterData !== null && subChapterData.title) {
                     html += `<h3>${subChapterData.subchapterNumber} ${subChapterData.title}</h3>`;
                     const basePath = `bsiAuditReport.dokumentenpruefung.${subChapterKey}`;

                     if (subChapterData.content) {
                        html += createQuestionBlock(subChapterData.content, basePath);
                     }
                     
                     // Handle nested sub-sub-chapters like in 3.3
                     for(const sectionKey in subChapterData) {
                         const sectionData = subChapterData[sectionKey];
                         if (typeof sectionData === 'object' && sectionData !== null && sectionData.title) {
                            html += `<h4>${sectionData.subchapterNumber} ${sectionData.title}</h4>`;
                            const sectionBasePath = `${basePath}.${sectionKey}`;
                            if(sectionData.content) {
                                html += createQuestionBlock(sectionData.content, sectionBasePath);
                            }
                         }
                     }
                }
            }
            return html;
        }
        
        function renderChapter4(data) {
            let html = `<h2 id="chapter-4">4. Erstellung eines Prüfplans</h2>`;
            const auditplanung = get(data, 'auditplanung', {});
            for(const key in auditplanung) {
                const section = auditplanung[key];
                 if (typeof section === 'object' && section !== null && section.title && section.table) {
                    html += `<h3>${section.subchapterNumber} ${section.title}</h3>`;
                    html += createTable(section.table, `bsiAuditReport.erstellungEinesPruefplans.auditplanung.${key}.table`);
                 }
            }
            return html;
        }

        function renderChapter5(data) {
            let html = `<h2 id="chapter-5">5. Vor-Ort-Audit</h2>`;
            const verificCtn = get(data, 'verifikationDesITGrundschutzChecks.einzelergebnisse', {});
            html += `<h3>5.5.2 Einzelergebnisse des IT-Grundschutz-Checks</h3>`;

            const bausteinPruefungen = get(verificCtn, 'bausteinPruefungen', []);
            bausteinPruefungen.forEach((bp, bpIndex) => {
                const bpBasePath = `bsiAuditReport.vorOrtAudit.verifikationDesITGrundschutzChecks.einzelergebnisse.bausteinPruefungen[${bpIndex}]`;
                html += `<div class="baustein-block">`;
                html += createTextInput('Baustein:', `${bpBasePath}.baustein`, bp.baustein);
                html += createTextInput('bezogen auf Zielobjekt:', `${bpBasePath}.bezogenAufZielobjekt`, bp.bezogenAufZielobjekt);
                html += createTextInput('Auditiert am:', `${bpBasePath}.auditiertAm`, bp.auditiertAm);
                html += createTextInput('Auditor(en):', `${bpBasePath}.auditor`, bp.auditor);
                html += createTextInput('Befragt wurde:', `${bpBasePath}.befragtWurde`, bp.befragtWurde);

                if (bp.anforderungen) {
                    bp.anforderungen.forEach((anf, anfIndex) => {
                        const anfBasePath = `${bpBasePath}.anforderungen[${anfIndex}]`;
                        html += `<div class="anforderung-block">`;
                        html += `<h4>Anforderung: ${anf.nummer || ''}</h4>`;
                        html += createTextArea('Anforderungstext:', `${anfBasePath}.anforderung`, anf.anforderung);
                        html += createTextInput('Bewertung der Anforderung:', `${anfBasePath}.bewertung`, anf.bewertung);
                        html += createTextArea('Dokumentation des Antragstellers zur Umsetzung dieser Anforderung:', `${anfBasePath}.dokuAntragsteller`, anf.dokuAntragsteller);
                        
                        // Prüfmethode Checkboxes
                        html += `<div class="form-group pruefmethode-group"><label>Prüfmethode:</label>`;
                        const pruefmethoden = get(anf, 'pruefmethode', {});
                        ['D', 'I', 'C', 'S', 'A', 'B'].forEach(method => {
                            const checked = pruefmethoden[method] ? 'checked' : '';
                            html += `<div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" ${checked} data-path="${anfBasePath}.pruefmethode.${method}">
                                        <label class="form-check-label">${method}</label>
                                     </div>`;
                        });
                        html += `</div>`;

                        html += createTextArea('Auditfeststellung im Detail mit Nachweisen:', `${anfBasePath}.auditfeststellung`, anf.auditfeststellung);
                        html += createTextArea('Es wurden folgende Abweichungen und Empfehlungen identifiziert:', `${anfBasePath}.abweichungen`, anf.abweichungen);
                        html += `</div>`;
                    });
                }
                html += `</div>`;
            });
            return html;
        }

        function renderChapter7(data) {
             let html = `<h2 id="chapter-7">7. Anhang</h2>`;
             const referenzdoku = get(data, 'referenzdokumente', {});
             if(referenzdoku.title) {
                 html += `<h3>${referenzdoku.subchapterNumber} ${referenzdoku.title}</h3>`;
                 html += createTable(referenzdoku.table, `bsiAuditReport.anhang.referenzdokumente.table`);
             }

             const abweichungen = get(data, 'abweichungenUndEmpfehlungen', {});
             if(abweichungen.title) {
                 html += `<h3>${abweichungen.subchapterNumber} ${abweichungen.title}</h3>`;
                 for(const key in abweichungen) {
                     const section = abweichungen[key];
                     if(typeof section === 'object' && section.title && section.table) {
                        html += `<h4>${section.title}</h4>`;
                        html += createTable(section.table, `bsiAuditReport.anhang.abweichungenUndEmpfehlungen.${key}.table`);
                     }
                 }
             }
             return html;
        }

    </script>
</body>
</html>